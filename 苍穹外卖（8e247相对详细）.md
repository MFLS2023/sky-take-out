# 前期准备

## 项目约定

![image-20240120163045330](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120163045330.png)

## 软件开发步骤及角色分工

![image-20240117232900297](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240117232900297.png)

## 软件环境

### 开发环境(development)

开发人员在开发阶段使用的环境，一般外部用户无法访问

### 测试环境(testing)

专门给测试人员使用的环境，用于测试项目，一般外部用户无法访问

### 生产环境(production)(线上环境)

正式提供对外服务的环境

## 产品原型

![image-20240117235722376](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240117235722376.png)

## 技术选型

### 定义

展示项目中使用的技术框架和中间件等

![image-20240118001229772](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240118001229772.png)

# 开发环境搭建

## 整体结构

![image-20240118001553808](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240118001553808.png)

## 前端环境搭建

![image-20240118002055200](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240118002055200.png)

## 后端环境搭建

### 熟悉项目结构

![image-20240119001942004](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240119001942004.png)

#### common子模块

![image-20240119002009463](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240119002009463.png)

#### sky-pojo子模块

![image-20240119002027005](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240119002027005.png)

#### sky-server子模块

![image-20240119002222370](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240119002222370.png)

### nginx反向代理

#### 定义

![image-20240120152436011](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120152436011.png)

#### 好处

![image-20240120152617688](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120152617688.png)

#### 反向代理的配置方式

![image-20240120152749884](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120152749884.png)

#### 负载均衡的配置方式

![image-20240120152852916](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120152852916.png)

#### 负载均衡的策略

![image-20240120153100575](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120153100575.png)

![image-20240120153212072](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120153212072.png)

### 完善登陆功能（MD5加密）

#### MD5信息机密算法

##### 定义

![image-20240120153447343](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120153447343.png)

#### 步骤

![image-20240120154120666](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120154120666.png)

## 导入接口文档

### 前后端分离开发的流程

![image-20240120155012086](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120155012086.png)

## Swagger

### 介绍

![image-20240120160115966](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120160115966.png)

### 使用方式

![image-20240120160349411](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120160349411.png)

![image-20240120160411328](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120160411328.png)

### swagger和YApi的不同使用场景

![image-20240120161626113](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120161626113.png)

### 常用注解

![image-20240120161734445](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120161734445.png)

# 员工接口处理

## 新增员工

### 步骤

![image-20240120162330941](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120162330941.png)

### 需求分析和设计

#### 产品原型分析

![image-20240120162639892](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120162639892.png)

#### 接口设计分析

![image-20240120162921674](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120162921674.png)

### 数据库表设计

![image-20240120163421440](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120163421440.png)

### 代码开发

#### 设计员工对应的DTO

![image-20240120163531104](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120163531104.png)

#### BeanUtlis对象属性转换

使用Spring提供的BeanUtlis工具类可以快速的转换DTO对象和实体类对象

#### 相关代码

##### controller

```java
/**
 * 新增员工
 * @param employeeDTO
 * @return
 */
@ApiOperation("新增员工")
@PostMapping
public Result save(@RequestBody EmployeeDTO employeeDTO){
    log.info("新增员工：{}",employeeDTO);
    employeeService.save(employeeDTO);
    return Result.success();
}
```

##### service

```java
/**
 * 新增员工
 *
 * @param employeeDTO
 */
@Override
public void save(EmployeeDTO employeeDTO) {
    Employee employee = new Employee();

    // 实体类属性转换
    BeanUtils.copyProperties(employeeDTO,employee);

    // 状态，实践等的输入
    employee.setStatus(StatusConstant.ENABLE);
    employee.setCreateTime(LocalDateTime.now());
    employee.setUpdateTime(LocalDateTime.now());
    employee.setPassword(DigestUtils.md5DigestAsHex(PasswordConstant.DEFAULT_PASSWORD.getBytes()));
    //TODO 更改创建人和修改人
    employee.setCreateUser(10L);
    employee.setUpdateUser(10L);

    // 插入员工数据
    employeeMapper.insert(employee);
}
```

##### mapper

```java
/**
 * 新增员工
 * @param employee
 */
@Insert("Insert into employee (id, name, username, password, phone, sex, id_number, status, create_time, update_time, create_user, update_user) " +
        "values " +
        "(#{id},#{name},#{username},#{password},#{phone},#{sex},#{idNumber},#{status},#{createTime},#{updateTime},#{createUser},#{updateUser})")
void insert(Employee employee);
```

### 功能测试

#### 方式

##### 通过接口文档测试

![image-20240120174146205](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120174146205.png)

![image-20240120174156097](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120174156097.png)

##### 通过前后端联调进行测试

![image-20240120174539533](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120174539533.png)

![image-20240120174556229](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120174556229.png)



#### 注意

![image-20240120173033578](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120173033578.png)

### 代码的完善

#### 当前问题

![image-20240120174653575](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120174653575.png)

##### 全局异常处理器

```java
@ExceptionHandler
public Result exceptionHandler(SQLIntegrityConstraintViolationException ex){
    log.error("异常信息：{}", ex.getMessage());
    String message = ex.getMessage();
    if (message.contains("Duplicate entry")){
        String[] split = message.split(" ");
        String userName = split[2];
        String mes = userName + MessageConstant.ALREADY_EXISTS;
        return Result.error(mes);
    }
    return Result.error(MessageConstant.UNKNOWN_ERROR);
}
```

##### 修改创建人id和修改人id

###### jwt令牌认证的流程

![image-20240120181809342](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240120181809342.png)

###### ThreadLocal

![image-20240121000202926](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121000202926.png)

```java
BaseContext.setCurrentId(empId);
```

## 员工分页查询

### 步骤

![image-20240121000303196](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121000303196.png)

### 需求分析和设计

#### 产品原型分析

![image-20240121000341398](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121000341398.png)

#### 接口分析

![image-20240121000627623](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121000627623.png)

### 代码开发

#### controller

```java
/**
 * 员工分页查询
 * @param employeePageQueryDTO
 * @return
 */
@ApiOperation("员工分页查询")
@GetMapping("/page")
public Result<PageResult> page(EmployeePageQueryDTO employeePageQueryDTO){
    log.info("查询员工：{}",employeePageQueryDTO);
    PageResult pageResult = employeeService.page(employeePageQueryDTO);
    return Result.success(pageResult);
}
```

#### service

```java
/**
 * 分页查询
 * @param employeePageQueryDTO
 * @return
 */
@Override
public PageResult page(EmployeePageQueryDTO employeePageQueryDTO) {
    // 使用分页查询插件进行动态分页
    PageHelper.startPage(employeePageQueryDTO.getPage(), employeePageQueryDTO.getPageSize());
    // 编写SQL语句
    Page<Employee> page = employeeMapper.PageQuery(employeePageQueryDTO.getName());
    // 拿到总记录数和结果
    long total = page.getTotal();
    List<Employee> list = page.getResult();
    //封装程PageResult对象
    PageResult pageResult = new PageResult();
    pageResult.setTotal(total);
    pageResult.setRecords(list);
    return pageResult;
}
```

#### mapper

```xml
<select id="PageQuery" resultType="com.sky.entity.Employee">
    select * from employee
    <where>
        <if test="name != null and name != ''">
            name like concat('%',#{name},'%')
        </if>
    </where>
    order by create_Time desc
</select>
```

### 功能测试

#### 接口文档测试

![image-20240121004844114](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121004844114.png)

#### 前后端联调

![image-20240121004901103](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121004901103.png)

### 代码完善

#### 当前问题

![image-20240121005337539](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121005337539.png)

操作时间展示不正确

#### 解决方式

![image-20240121005458811](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121005458811.png)

##### 消息转换器

```java
@Override
protected void extendMessageConverters(List<HttpMessageConverter<?>> converters) {
    // 设置一个消息转换器
    MappingJackson2HttpMessageConverter converter = new MappingJackson2HttpMessageConverter();
    // 设置对象转换器，转换为json参数
    converter.setObjectMapper(new JacksonObjectMapper());
    //加入消息转换器
    converters.add(0,converter);
}
```

![image-20240121010628064](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121010628064.png)

## 启用禁用员工账号

### 步骤

![image-20240121174055757](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121174055757.png)

### 需求分析和设计

#### 产品原型分析

![image-20240121174128200](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121174128200.png)

##### 业务规则

![image-20240121174214278](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121174214278.png)

#### 接口设计

![image-20240121174241768](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121174241768.png)

### 代码开发

#### controller

```java
/**
 * 员工状态调整
 * @param status
 * @param id
 * @return
 */
@ApiOperation("员工状态管理")
@PostMapping("/status/{status}")
public Result changeStatus(@PathVariable Integer status, long id){
    log.info("更改人：{},更改状态：{}",id,status);
    employeeService.changeStatus(status,id);
    return Result.success();
}
```

#### service

```java
/**
 * 员工状态调整
 * @param status
 * @param id
 * @return
 */
@Override
public void changeStatus(Integer status, long id) {
    Employee employee = Employee.builder()
            .status(status)
            .id(id)
            .updateTime(LocalDateTime.now()).build();
   employeeMapper.changeStatus(employee);
}
```

#### mapper

```xml
<update id="changeStatus">
    update employee
    <set>
        <if test="name != null">name = #{name},</if>
        <if test="idNumber != null">id_Number = #{idNumber},</if>
        <if test="phone != null">phone = #{phone,}</if>
        <if test="sex != null">sex = #{sex},</if>
        <if test="username != null">username = #{username},</if>
        <if test="status != null">status = #{status},</if>
        <if test="updateTime != null">update_Time = #{updateTime},</if>
        <if test="password != null">password = #{password},</if>
        <if test="updateUser != null">update_User = #{updateUser},</if>
    </set>
     where id = #{id}
</update>
```

### 功能测试

#### 接口文档测试

![image-20240121175100132](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121175100132.png)

#### 前后端联调测试

![image-20240121175121873](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121175121873.png)

![image-20240121175130763](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121175130763.png)

## 编辑员工

### 步骤

![image-20240121182700572](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121182700572.png)

### 需求分析和设计

#### 产品原型分析

![image-20240121183635797](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121183635797.png)

#### 接口分析

![image-20240121183653660](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121183653660.png)

### 代码开发

#### controller

```java
/**
 * 编辑员工信息
 * @param employee
 * @return
 */
@ApiOperation("编辑员工信息")
@PutMapping
public Result changeInformation(@RequestBody Employee employee){
    log.info("编辑员工信息");
    employee.setUpdateUser(BaseContext.getCurrentId());
    employee.setUpdateTime(LocalDateTime.now());
    employeeService.changeInformation(employee);
    return Result.success();
}

/**
 * 根据id查询员工
 * @param id
 * @return
 */
@ApiOperation("根据id查询员工")
@GetMapping("/{id}")
public Result getById(@PathVariable long id){
    log.info("根据id查询员工");
    Employee employee = employeeService.getById(id);
    return Result.success(employee);
}
```

#### service

```java
/**
 * 编辑员工信息
 * @param employee
 * @return
 */
@Override
public void changeInformation(Employee employee) {
    employeeMapper.changeInformation(employee);
}

/**
 * 根据id查询员工
 * @param id
 * @return
 */
@Override
public Employee getById(long id) {
    Employee employee = employeeMapper.getById(id);
    return employee;
}
```

#### mapper

```java
/**
 * 根据id查询员工
 * @param id
 * @return
 */
@Select("select * from employee where id = #{id}")
Employee getById(long id);
```

```xml
<update id="changeInformation">
    update employee
    <set>
        <if test="name != null">name = #{name},</if>
        <if test="idNumber != null">id_Number = #{idNumber},</if>
        <if test="phone != null">phone = #{phone},</if>
        <if test="sex != null">sex = #{sex},</if>
        <if test="username != null">username = #{username},</if>
        <if test="status != null">status = #{status},</if>
        <if test="updateTime != null">update_Time = #{updateTime},</if>
        <if test="password != null">password = #{password},</if>
        <if test="updateUser != null">update_User = #{updateUser},</if>
    </set>
    where id = #{id}
</update>
```

### 功能测试

#### 接口文档测试

![image-20240121193542143](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121193542143.png)

![image-20240121193631992](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121193631992.png)

#### 前后端联调测试

![image-20240121193658545](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121193658545.png)

![image-20240121193731261](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121193731261.png)

# 分类接口处理

## 分类分页查询

### 需求分析和设计

![image-20240121235531738](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240121235531738.png)

### 代码开发

#### Controller

```java
/**
 * 菜品分页查询
 * @param categoryPageQueryDTO
 * @return
 */
@ApiOperation("菜品分页查询")
@GetMapping("/page")
public Result<PageResult> Page(CategoryPageQueryDTO categoryPageQueryDTO){
    log.info("菜品分页查询");
    PageResult pageResult = categoryService.page(categoryPageQueryDTO);
    if (pageResult != null){
        return Result.success(pageResult);
    }else {
        return Result.error("菜品查询出现问题，请联系管理员解决");
    }
}
```

#### Service

```java
/**
 * 菜品分页查询
 * @param categoryPageQueryDTO
 * @return
 */
@Override
public PageResult page(CategoryPageQueryDTO categoryPageQueryDTO) {
    // 使用分页查询插件动态分页
    PageHelper.startPage(categoryPageQueryDTO.getPage(), categoryPageQueryDTO.getPageSize());
    //使用SQL语句查询数据
    Page<Category> page = categoryMapper.pageQuery(categoryPageQueryDTO);
    // 拿到总记录数和数据，封装到PageResult对象中
    long total = page.getTotal();
    List<Category> list = page.getResult();

    PageResult pageResult = new PageResult();
    pageResult.setTotal(total);
    pageResult.setRecords(list);
    return pageResult;
}
```

#### Mapper

```xml
<select id="pageQuery" resultType="com.sky.entity.Category">
    select * from category
    <where>
        <if test="name != null and name != ''">name like concat('%',#{name},'%'),</if>
        <if test="type != null">type = #{type}</if>
    </where>
</select>
```

### 功能测试

#### 接口文档测试

![image-20240122000024660](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122000024660.png)

#### 前后端联调测试

![image-20240122000143823](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122000143823.png)

## 新增分类

### 需求分析和设计

![image-20240122013232963](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122013232963.png)

### 代码开发

#### Controller

```java
/**
 * 新增分类
 * @param categoryDTO
 * @return
 */
@ApiOperation("新增分类")
@PostMapping
public Result Save(@RequestBody CategoryDTO categoryDTO){
    log.info("新增菜品");
    categoryService.save(categoryDTO);
    return Result.success();
}
```

#### Service

```java
/**
 * 新增分类
 * @param categoryDTO
 */
@Override
public void save(CategoryDTO categoryDTO) {
    Category category = new Category();
    BeanUtils.copyProperties(categoryDTO,category);
    category.setStatus(0);
    category.setCreateTime(LocalDateTime.now());
    category.setUpdateTime(LocalDateTime.now());
    category.setCreateUser(BaseContext.getCurrentId());
    category.setUpdateUser(BaseContext.getCurrentId());
    categoryMapper.save(category);
}
```

#### Mapper

```xml
<insert id="save">
    insert category(id, type, name, sort, status, create_time, update_time, create_user, update_user)
    values (#{id},#{type},#{name}, #{sort}, #{status},#{createTime} ,#{updateTime} ,#{createUser} ,#{updateUser})
</insert>
```

### 功能测试

#### 接口文档测试

![image-20240122013414471](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122013414471.png)

#### 前后端联调测试

![image-20240122013446187](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122013446187.png)

## 分类类型查询

### 需求分析和设计

![image-20240122013534941](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122013534941.png)

### 代码开发

#### Controller

```java
/**
 * 菜品类型分类查询
 * @param type
 * @return
 */
@ApiOperation("菜品类型分类查询")
@GetMapping("/list")
public Result SelectByType(Integer type){
    log.info("菜品分类查询：{}",type);
    List<Category> categoryList = categoryService.SelectByType(type);
    return Result.success(categoryList);
}
```

#### Service

```java
/**
 * 菜品类型查询
 * @param type
 * @return
 */
@Override
public List<Category> SelectByType(Integer type) {
    List<Category> categoryList = categoryMapper.SelectByType(type);
    return  categoryList;
}
```

#### Mapper

```xml
<select id="SelectByType" resultType="com.sky.entity.Category">
    select * from category
    <where>
        status = 1,
        <if test="type！= null ">type = #{type}</if>
        order by sort asc,create_time desc
    </where>
</select>
```

### 功能测试

#### 接口文档测试

![image-20240122014051493](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122014051493.png)

## 根据id删除分类

### 需求分析和设计

![image-20240122230822547](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122230822547.png)

### 代码开发

#### Controller

```java
/**
 * 根据id删除分类
 * @param id
 * @return
 */
@ApiOperation("根据id删除分类")
@DeleteMapping
public Result DeleteById(long id){
    log.info("根据id删除分类");
    categoryService.DeleteById(id);
    return Result.success();
}
```

#### Service

```java
/**
 * 根据id删除分类
 * @param id
 */
@Override
public void DeleteById(long id) {
    // 查询是否关联了菜品
    Integer dishNum = dishMapper.getCountById(id);
    if(dishNum > 0){
        throw new DeletionNotAllowedException(MessageConstant.CATEGORY_BE_RELATED_BY_DISH);
    }
    // 查询是否关联了套餐
    dishNum = setMealMapper.getCountById(id);
    if(dishNum > 0){
        throw new DeletionNotAllowedException(MessageConstant.CATEGORY_BE_RELATED_BY_SETMEAL);
    }
    categoryMapper.DeleteById(id);
}
```

#### Mapper

```java
/**
 * 根据id删除分类
 * @param id
 */
@Delete("delete from category where id = #{id}")
void DeleteById(long id);
```

```java
/**
 * 查询分类关联菜品的数量
 * @param id
 */
@Select("select count(id) from dish where category_id = #{id}")
Integer getCountById(long id);
```

```java
/**
 * 查询分类关联菜品的数量
 * @param id
 */
@Select("select count(id) from setmeal where category_id = #{id}")
public Integer getCountById(long id);
```

### 功能测试

#### 接口文档测试

![image-20240122231300953](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122231300953.png)

#### 前后端联调测试

![image-20240122231315360](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122231315360.png)

## 修改分类

### 需求分析和设计

![image-20240122233333667](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122233333667.png)

### 代码开发

#### Controller

```java
/**
 * 修改分类
 * @param categoryDTO
 * @return
 */
@ApiOperation("修改分类")
@PutMapping
public Result ChangeCategory(@RequestBody CategoryDTO categoryDTO){
    categoryService.ChangeCategory(categoryDTO);
    return Result.success();
}
```

#### Service

```java
/**
 * 修改分类
 * @param categoryDTO
 */
@Override
public void ChangeCategory(CategoryDTO categoryDTO) {
    Category category = new Category();
    // 将DTO对象转换为实体类
    BeanUtils.copyProperties(categoryDTO,category);
    // 添加修改人和修改实践
    category.setUpdateUser(BaseContext.getCurrentId());
    category.setUpdateTime(LocalDateTime.now());
    // 使用SQL语句修改分类
    categoryMapper.ChangeCategory(category);
```

#### Mapper

```xml
<update id="ChangeCategory">
    update category
    <set>
        <if test="name != null and name != ''">name = #{name},</if>
        <if test="sort != null">sort = #{sort},</if>
        <if test="type != null">type = #{type},</if>
    </set>
    where id = #{id}
</update>
```

### 功能测试

#### 接口文档测试

![image-20240122233231128](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122233231128.png)

#### 前后端联调测试

![image-20240122233152441](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122233152441.png)

## 启用，禁用分类

### 需求分析和设计

![image-20240122234111681](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122234111681.png)

### 代码开发

#### Controller

```java
/**
 * 启用禁用
 * @param status
 * @param id
 */
@ApiOperation("启用禁用")
@PostMapping("/status/{status}")
public Result OpenOrStop(@PathVariable Integer status,long id){
    categoryService.OpenOrStop(status,id);
    return Result.success();
}
```

#### Service

```java
/**
 * 启用禁用
 * @param status
 * @param id
 */
@Override
public void OpenOrStop(Integer status, long id) {
    categoryMapper.OpenOrStop(status,id);
}
```

#### Mapper

```java
/**
 * 启用禁用
 * @param status
 * @param id
 */
@Update("update category set status = #{status} where id = #{id}")
void OpenOrStop(Integer status, long id);
```

### 功能测试

#### 接口文档测试

![image-20240122233911433](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122233911433.png)

#### 前后端联调测试

![image-20240122233922618](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240122233922618.png)

# 公共字段自动填充

## 实现思路

![image-20240124003347433](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240124003347433.png)

### 自定义注解

```java
package com.sky.annotation;

import com.sky.enumeration.OperationType;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface AutoFill {

    OperationType value();
}
```

### AOP切面类

```java
package com.sky.aspect;

import com.sky.annotation.AutoFill;
import com.sky.constant.AutoFillConstant;
import com.sky.context.BaseContext;
import com.sky.enumeration.OperationType;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.annotation.Pointcut;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.stereotype.Component;

import java.lang.annotation.Annotation;
import java.lang.reflect.Method;
import java.time.LocalDateTime;

@Aspect
@Component
@Slf4j
public class AutoFillAspect {

    @Pointcut("execution(* com.sky.mapper.*.*(..)) && @annotation(com.sky.annotation.AutoFill)")
    public void AutoFillPointCut(){}

    @Before("AutoFillPointCut()")
    public void autoFill(JoinPoint joinPoint){
        log.info("自动字段填充");
        // 通过连接点对象获取到在在执行的对象
        MethodSignature signature = (MethodSignature) joinPoint.getSignature(); // 获取到方法签名
        // 拿到对应注解所使用的方法
        AutoFill autoFill = signature.getMethod().getAnnotation(AutoFill.class);
        // 获取到这个方法的操作类型
        OperationType type = autoFill.value();
        // 获得方法的参数
        Object[] pointArgs = joinPoint.getArgs();
        // 拿到实体类对象
        Object entity = pointArgs[0];
        // 获取当前时间和操作人id
        LocalDateTime now = LocalDateTime.now();
        Long id = BaseContext.getCurrentId();
        // 对不同的操作类型使用不同的反射
        if (type == OperationType.INSERT){
            try {
                Method setCreateTime = entity.getClass().getDeclaredMethod(AutoFillConstant.SET_CREATE_TIME, LocalDateTime.class);
                Method setUpdateTime = entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_TIME, LocalDateTime.class);
                Method setCreateUser = entity.getClass().getDeclaredMethod(AutoFillConstant.SET_CREATE_USER, Long.class);
                Method setUpdateUser = entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_USER, Long.class);

                // 为获得的方法对象赋值
                setCreateTime.invoke(entity,now);
                setUpdateTime.invoke(entity,now);
                setCreateUser.invoke(entity,id);
                setUpdateUser.invoke(entity,id);

            } catch (Exception e) {
                e.printStackTrace();
            }
        }else if(type == OperationType.UPDATE){
            try {
                Method setUpdateTime = entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_TIME, LocalDateTime.class);
                Method setUpdateUser = entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_USER, Long.class);

                // 为获得的方法对象赋值
                setUpdateTime.invoke(entity,now);
                setUpdateUser.invoke(entity,id);

            } catch (Exception e) {
                e.printStackTrace();
            }
        }

    }
}
```

# 文件上传

## 代码

### 配置类

```java
package com.sky.config;

import com.sky.properties.AliOssProperties;
import com.sky.utils.AliOssUtil;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Slf4j
@Configuration
public class OssConfiguration {

    @ConditionalOnMissingBean
    @Bean
    public AliOssUtil aliOssUtil(AliOssProperties aliOssProperties){
        log.info("开始创建AliOss对象：{}",aliOssProperties);
        return new AliOssUtil(aliOssProperties.getEndpoint(),
                aliOssProperties.getAccessKeyId(),
                aliOssProperties.getAccessKeySecret(),
                aliOssProperties.getBucketName());
    }

}
```

### yml文件配置

```yaml
alioss:
  endpoint: oss-cn-beijing.aliyuncs.com
  access-key-id: LTAI5tHiXJMWXM5ghoe4QiWa
  access-key-secret: k6ctjNV1cnO7xAPzZ9WDp38p1OgUm4
  bucket-name: sky-takeout-itheima
```

### controller

```java
@Api(tags = "公用接口")
@RestController
@Slf4j
@RequestMapping("/admin/common")
public class CommonController {

    @Autowired
    private AliOssUtil aliOssUtil;

    @ApiOperation("图片上传")
    @PostMapping("/upload")
    public Result<String> upload(MultipartFile file){
        log.info("文件开始上传：{}",file);

        try {
            // 获取文件原始文件名
            String originalFilename = file.getOriginalFilename();
            // 拿到文件后缀
            String last = originalFilename.substring(originalFilename.lastIndexOf("."));
            // 使用UUID拼接文件名
            String objectName = UUID.randomUUID().toString() + last;
            String upload = aliOssUtil.upload(file.getBytes(), objectName);
            return Result.success(upload);
        } catch (IOException e) {
            log.error("文件上传失败");
            e.printStackTrace();
        }
        return Result.error(MessageConstant.UPLOAD_FAILED);
    }
}
```

## 功能测试

### 前后端联调

![image-20240125014351523](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240125014351523.png)

## 新增菜品

### 需求分析和设计

![image-20240127225439048](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127225439048.png)

### 代码开发

#### Controller

```java
/**
 * 新增菜品
 * @param dishDTO
 * @return
 */
@PostMapping
@ApiOperation("新增菜品")
public Result save(@RequestBody DishDTO dishDTO){
    log.info("开始保存菜品");
    dishService.save(dishDTO);
    return Result.success();
}
```

#### Service

```java
/**
 * 新增菜品
 * @param dishDTO
 */
@Override
public void save(DishDTO dishDTO) {
    Dish dish = new Dish();
    BeanUtils.copyProperties(dishDTO,dish);
    dish.setStatus(0);
    // 新增菜品
    dishMapper.saveWithFlavors(dish);
    // 获取到新增菜品的id
    Long id = dishMapper.SelectIdByName(dish);
    log.info("获取到菜品id:{}",id);
    // 新增口味表
    List<DishFlavor> flavors = dishDTO.getFlavors();
    if (flavors != null && flavors.size() > 0){
        for (DishFlavor dishFlavor:flavors){
            log.info("开始注入id");
            dishFlavor.setDishId(id);
        }
        log.info("开始保存口味数据");
        flavorMapper.saveById(flavors);
    }
}
```

#### Mapper

```xml
<insert id="saveWithFlavors">
    insert dish(name, category_id, price, image, description, status, create_time, update_time, create_user, update_user)
    values (#{name},#{categoryId}, #{price}, #{image},#{description} ,#{status} ,#{createTime} ,#{updateTime} ,#{createUser} ,#{updateUser})
</insert>
```

### 功能测试

#### 前后端联调测试

![image-20240127225729228](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127225729228.png)

![image-20240127225742318](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127225742318.png)

## 菜品分页查询

### 需求分析和设计

![image-20240127225923391](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127225923391.png)

### 代码开发

#### Controller

```java
/**
 * 菜品分页查询
 * @param dishPageQueryDTO
 * @return
 */
@GetMapping("/page")
@ApiOperation("菜品分页查询")
public Result<PageResult> selectByPage(DishPageQueryDTO dishPageQueryDTO){
    log.info("菜品分页查询开始:{}",dishPageQueryDTO);
    PageResult pageResult = dishService.selectByPage(dishPageQueryDTO);
    return Result.success(pageResult);
}
```

#### Service

```java
/**
 * 菜品分页查询
 * @param dishPageQueryDTO
 * @return
 */
@Override
public PageResult selectByPage(DishPageQueryDTO dishPageQueryDTO) {
    // 设置分页
    PageHelper.startPage(dishPageQueryDTO.getPage(),dishPageQueryDTO.getPageSize());
    // 编写SQL语句
    Page<DishVO> list = dishMapper.SelectByPage(dishPageQueryDTO);
    log.info("获取到菜品信息：{}",list);
    for (DishVO dishVO : list) {
        dishVO.setCategoryName(categoryMapper.SelectNameByDishId(dishVO.getCategoryId()));
        dishVO.setFlavors(flavorMapper.SelectByDishId(dishVO.getId()));
    }
    // 构建PageResult类型
    PageResult pageResult = new PageResult();
    pageResult.setTotal(list.getTotal());
    pageResult.setRecords(list.getResult());
    return pageResult;
}
```

#### Mapper

```xml
<select id="SelectByPage" resultType="com.sky.vo.DishVO">
    select * from dish
    <where>
        <if test="name != null and name != ''">name like concat('%',#{name},'%')</if>
        <if test="status != null">status = #{status}</if>
        <if test="categoryId != null">category_id = #{categoryId}</if>
    </where>
</select>
```

### 功能测试

#### 接口文档测试

![image-20240127230310333](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127230310333.png)

#### 前后端联调测试

![image-20240127230156605](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127230156605.png)

## 删除菜品

### 需求分析和设计

![image-20240127230452563](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127230452563.png)

### 代码开发

#### Controller

```java
/**
 * 删除菜品
 * @return
 */
@ApiOperation("删除菜品")
@DeleteMapping
public Result DeleteByDishId(@RequestParam List<Long> ids){
    log.info("开始删除菜品");
    dishService.DeleteByDishId(ids);
    return Result.success();
}
```

#### Service

```java
/**
 * 删除菜品
 * @param ids
 * @return
 */
@Override
public void DeleteByDishId(List<Long> ids) {
    // 判断菜品是否在售卖中
    ids.forEach(id -> {
        Integer status = dishMapper.selectStatusById(id);
        if(status == StatusConstant.ENABLE){
            throw new DeletionNotAllowedException(MessageConstant.DISH_ON_SALE);
        }
    });
    // 查询菜品是否关键某个套餐
    ids.forEach(id ->{
        Integer count = setMealDishMapper.selectCountByDishId(id);
        if (count > 0){
            throw new DeletionNotAllowedException(MessageConstant.DISH_BE_RELATED_BY_SETMEAL);
        }
    });
    // 判断完成，删除口味以及菜品
    flavorMapper.deleteByDishId(ids);
    dishMapper.deleteById(ids);
}
```

#### Mapper

```xml
<delete id="deleteById">
    delete from dish
    <where>
        id in
        <foreach collection="ids" item="id" separator="," open="(" close=")">
            #{id}
        </foreach>
    </where>
</delete>
```

### 功能测试

#### 接口文档测试

![image-20240127230656510](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127230656510.png)

#### 前后端联调测试

![image-20240127230714849](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127230714849.png)![image-20240127230724653](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127230724653.png)

![image-20240127230739299](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127230739299.png)

## 修改菜品

### 需求分析和设计

![image-20240127230842357](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127230842357.png)

### 代码开发

#### Controller

```java
/**
 * 根据id查询菜品
 * @param id
 * @return
 */
@GetMapping("/{id}")
@ApiOperation("根据id查询菜品")
public Result<DishVO> selectByDishId(@PathVariable Long id){
    log.info("开始查询菜品：{}",id);
    DishVO dishVO = dishService.selectByDishId(id);
    return Result.success(dishVO);
}

/**
 * 修改菜品
 * @param dishDTO
 * @return
 */
@PutMapping
@ApiOperation("修改菜品")
public Result ChangeDish(@RequestBody DishDTO dishDTO){
    log.info("开始修改菜品");
    dishService.changeDish(dishDTO);
    return Result.success();
}
```

#### Service

```java
/**
 * 根据id查询菜品
 * @param id
 * @return
 */
@Override
public DishVO selectByDishId(Long id) {
    DishVO dishVO = dishMapper.selectByDishId(id);
    dishVO.setCategoryName(categoryMapper.SelectNameByDishId(id));
    dishVO.setFlavors(flavorMapper.SelectByDishId(id));
    return dishVO;
}

/**
 * 修改菜品
 * @param dishDTO
 */
@Override
public void changeDish(DishDTO dishDTO) {
    Dish dish = new Dish();
    BeanUtils.copyProperties(dishDTO,dish);
    dish.setStatus(0);
    // 更新菜品数据
    dishMapper.updateByDishId(dish);
    // 获取到菜品的id
    Long id = dish.getId();
    log.info("获取到菜品id:{}",id);
    // 删除原有菜品口味
    flavorMapper.deleteByOneDishId(id);
    // 更新
    List<DishFlavor> flavors = dishDTO.getFlavors();
    if (flavors != null && flavors.size() > 0){
        for (DishFlavor dishFlavor:flavors){
            log.info("开始注入id");
            dishFlavor.setDishId(id);
        }
        log.info("开始更新口味数据");
        flavorMapper.saveById(flavors);
    }
}
```

#### Mapper

```xml
<update id="updateByDishId">
    update dish
    <set>
        <if test="name != null">name = #{name},</if>
        <if test="description != null">description = #{description},</if>
        <if test="image != null">image = #{image},</if>
        <if test="categoryId != null">category_id = #{categoryId},</if>
        <if test="price != null">price = #{price},</if>
        <if test="updateTime != null">update_time = #{updateTime},</if>
        <if test="updateUser != null">update_user = #{updateUser},</if>
    </set>
    <where>
        id = #{id}
    </where>
</update>
```

### 功能测试

#### 前后端联调测试

![image-20240127233521710](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127233521710.png)

## 根据分类id查询菜品信息

### 需求分析和设计

![image-20240127235249794](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127235249794.png)

### 代码开发

#### Controller

```java
/**
 * 根据分类id查询菜品
 * @param categoryId
 * @return
 */
@GetMapping("/list")
@ApiOperation("根据分类id查询菜品信息")
public Result<List<DishVO>> SelectByCategoryId(Long categoryId){
    List<DishVO> list = dishService.SelectByCategoryId(categoryId);
    return Result.success(list);
}
```

#### Service

```java
/**
 * 根据分类id查询菜品信息
 * @param categoryId
 * @return
 */
@Override
public List<DishVO> SelectByCategoryId(Long categoryId) {
    List<DishVO> list = dishMapper.SelectByCategoryId(categoryId);
    return list;
}
```

#### Mapper

```java
@Select("select * from dish where category_id = #{categoryId}")
List<DishVO> SelectByCategoryId(Long categoryId);
```

### 功能测试

#### 接口文档测试

![image-20240127235434999](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127235434999.png)

#### 前后端联调测试

![image-20240127235341862](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240127235341862.png)

# 套餐接口设计

## 新增套餐

### 需求分析和设计

![image-20240128173915892](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240128173915892.png)

### 代码开发

#### Controller

```java
/**
 * 新增套餐
 * @param setmealDTO
 * @return
 */
@Transactional
@PostMapping
@ApiOperation("新增套餐")
public Result Save(@RequestBody SetmealDTO setmealDTO){
    log.info("开始保存套餐:{}",setmealDTO);
    setMealService.save(setmealDTO);
    return Result.success();
}
```

#### Service

```java
/**
 * 新增套餐
 * @param setmealDTO
 */
@Override
public void save(SetmealDTO setmealDTO) {
    // 创建套餐实体类，传输数据
    Setmeal setmeal = new Setmeal();
    // 把DTO参数拷贝给实体类
    BeanUtils.copyProperties(setmealDTO,setmeal);
    setmeal.setStatus(0);
    // 将实体类参数传输到数据库
    setMealMapper.save(setmeal);
    Long id = setMealMapper.getIdByName(setmeal.getName());
    // 将菜品信息传输到数据库中
    List<SetmealDish> list = setmealDTO.getSetmealDishes();
    list.forEach(setmealDish -> {
        setmealDish.setSetmealId(id);
    });
    setMealDishMapper.saveByList(list);
}
```

#### Mapper

```xml
<insert id="save">
    insert into setmeal(category_id, name, price, status, description, image, create_time, update_time, create_user, update_user)
    values (#{categoryId},#{name}, #{price}, #{status},#{description},#{image},#{createTime} ,#{updateTime} ,#{createUser} ,#{updateUser})
</insert>
```

```xml
<!--    <insert id="saveByList" parameterType="list">-->
<!--        insert into setmeal_dish-->
<!--        (setmeal_id,dish_id,name,price,copies)-->
<!--        values-->
<!--        <foreach collection="list" item="sd" separator=",">-->
<!--            (#{sd.setmealId},#{sd.dishId},#{sd.name},#{sd.price},#{sd.copies})-->
<!--        </foreach>-->
<!--    </insert>-->
```

### 功能测试

#### 前后端联调测试

![image-20240128174222134](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240128174222134.png)![image-20240128174230453](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240128174230453.png)

## 套餐分页查询

### 需求分析和设计

![image-20240128174341808](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240128174341808.png)

### 代码开发

#### Controller

```java
/**
 * 套餐分页查询
 * @param setmealPageQueryDTO
 * @return
 */
@GetMapping("/page")
@ApiOperation("分页查询")
public Result<PageResult> SelectByPage(SetmealPageQueryDTO setmealPageQueryDTO){
    log.info("开始分页查询：{}",setmealPageQueryDTO);
    PageResult pageResult = setMealService.selectByPage(setmealPageQueryDTO);
    return Result.success(pageResult);
}
```

#### Service

```java
/**
 * 菜品分页查询
 * @param setmealPageQueryDTO
 * @return
 */
@Override
public PageResult selectByPage(SetmealPageQueryDTO setmealPageQueryDTO) {
    // 设置分页参数
    PageHelper.startPage(setmealPageQueryDTO.getPage(),setmealPageQueryDTO.getPageSize());
    // 书写SQL语句，获得套餐数据
    Page<SetmealVO> page = setMealMapper.selectByPage(setmealPageQueryDTO);
    log.info("查询完毕");
    // 封装剩余数据
    for (SetmealVO setmealVO : page) {
        setmealVO.setCategoryName(categoryMapper.SelectNameById(setmealVO.getCategoryId()));
        setmealVO.setSetmealDishes(setMealDishMapper.selectByDishId(setmealVO.getId()));
    }
    // 封装PageResult对象
    PageResult pageResult = new PageResult();
    pageResult.setTotal(pageResult.getTotal());
    pageResult.setRecords(page.getResult());
    return pageResult;
}
```

#### Mapper

```xml
<select id="selectByPage" resultType="com.sky.vo.SetmealVO">
    select * from setmeal
    <where>
        <if test="name != null and name != ''">name like concat('%',#{name},'%')</if>
        <if test="status != null">status = #{status}</if>
        <if test="categoryId != null">category_id = #{categoryId}</if>
    </where>
</select>
```

### 功能测试

#### 前后端联调测试

![image-20240128174523013](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240128174523013.png)

## 套餐起售、停售

### 需求分析和设计

![image-20240129000208860](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129000208860.png)

### 代码开发

#### Controller

```java
/**
 * 套餐的起售，停售
 *
 * @param status
 * @param id
 * @return
 */
@PostMapping("/status/{status}")
@ApiOperation("套餐的起售，停售")
public Result StartOrStop(@PathVariable Integer status, Long id) {
    log.info("开始改变菜品的状态，id:{},status:{}", id, status);
    setMealService.StartOrStop(status, id);
    return Result.success();
}
```

#### Service

```java
/**
 * 套餐的起售停售
 * @param status
 * @param id
 */
@Override
public void StartOrStop(Integer status, Long id) {
    Setmeal setmeal = new Setmeal();
    setmeal.setId(id);
    setmeal.setStatus(status);
    setMealMapper.StartOrStop(setmeal);
}
```

#### Mapper

```java
/**
 * 套餐的起售停售
 * @param setmeal
 */
@AutoFill(OperationType.UPDATE)
@Update("update setmeal set status = #{status},update_user = #{updateUser},update_time = #{updateTime}")
void StartOrStop(Setmeal setmeal);
```

### 功能测试

#### 前后端联调测试

![image-20240129000437315](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129000437315.png)

## 批量删除套餐

### 需求分析和设计

![image-20240129000508396](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129000508396.png)

### 代码开发

#### Controller

```java
/**
 * 删除套餐
 *
 * @param ids
 * @return
 */
@Transactional
@DeleteMapping
@ApiOperation("删除套餐")
public Result DeleteByIds(@RequestParam List<Long> ids) {
    log.info("删除操作开始：{}", ids);
    setMealService.deleteByIds(ids);
    return Result.success();
}
```

#### Service

```java
/**
 * 删除套餐
 * @param ids
 */
@Override
public void deleteByIds(List<Long> ids) {
    // 先判断该套餐是否在售
    for (Long id : ids) {
       Integer status = setMealMapper.selectStatusById(id);
       if (StatusConstant.ENABLE == status){
           throw new DeletionNotAllowedException(MessageConstant.SETMEAL_ON_SALE);
       }
    }
    // 判断完成，进行删除操作
    setMealDishMapper.deleteByIds(ids);
    setMealMapper.deleteByIds(ids);
}
```

### 功能测试

#### 前后端联调测试

![image-20240129000623934](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129000623934.png)![image-20240129000634979](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129000634979.png)

## 根据id查询套餐

### 需求分析和设计

![image-20240129000707873](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129000707873.png)

### 代码开发

#### Controller

```java
/**
 * 根据id查询套餐数据
 *
 * @param id
 * @return
 */
@ApiOperation("根据id查询套餐数据")
@GetMapping("/{id}")
public Result<SetmealVO> SelectById(@PathVariable Long id) {
    log.info("正在根据id查询回显");
    SetmealVO setmealVO = setMealService.SelectById(id);
    return Result.success(setmealVO);
}
```

#### Service

```java
/**
 * 根据id查询套餐数据
 * @param id
 * @return
 */
@Override
public SetmealVO SelectById(Long id) {
    SetmealVO setmealVO = setMealMapper.SelectById(id);
    List<SetmealDish> list = setMealDishMapper.SelectBySetMealId(id);
    setmealVO.setSetmealDishes(list);
    return setmealVO;
}
```

### 功能测试

#### 前后端联调测试

![image-20240129000830232](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129000830232.png)

## 修改套餐

### 需求分析和设计

![image-20240129000905934](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129000905934.png)![image-20240129000921223](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129000921223.png)

### 代码开发

#### Controller

```java
/**
 * 修改套餐
 * @param setmealDTO
 * @return
 */
@PutMapping
@ApiOperation("修改套餐")
public Result ChangeSetMeal(@RequestBody SetmealDTO setmealDTO){
    log.info("开始更新菜品：{}",setmealDTO);
    setMealService.changeSetMeal(setmealDTO);
    return Result.success();
}
```

#### Service

```java
/**
 * 修改套餐
 * @param setmealDTO
 */
@Override
public void changeSetMeal(SetmealDTO setmealDTO) {
    Setmeal setmeal = new Setmeal();
    // 赋值
    BeanUtils.copyProperties(setmealDTO,setmeal);
    setmeal.setStatus(0);
    // 更新
    setMealMapper.UpdateSetMeal(setmeal);
    // 删除原有菜品关联
    setMealDishMapper.deleteById(setmeal.getId());
    // 保存新的菜品关系
    List<SetmealDish> list = setmealDTO.getSetmealDishes();
    list.forEach(setmealDish -> {
        setmealDish.setSetmealId(setmeal.getId());
    });
    setMealDishMapper.saveByList(list);
}
```

### 功能测试

#### 前后端联调测试

![image-20240129001047618](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129001047618.png)

# Redis

## Redis数据类型

### 介绍

![image-20240129001807238](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129001807238.png)

### 各种数据类型的特点

![image-20240129002724082](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129002724082.png)

## Redis操作命令

### 字符串操作命令

![image-20240129003021330](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129003021330.png)

![image-20240129003500120](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129003500120.png)

### 哈希操作命令

![image-20240129003515682](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129003515682.png)

![image-20240129004241489](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129004241489-17064601626801.png)

### 列表做做命令

![image-20240129004309677](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129004309677.png)

![image-20240129004332776](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129004332776.png)

### 集合操作命令

![image-20240129004451338](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129004451338.png)

![image-20240129004528794](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129004528794.png)

### 有序集合操作命令

![image-20240129004549427](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129004549427.png)

![image-20240129004617718](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129004617718.png)

### 通用命令

![image-20240129004633540](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129004633540.png)

![image-20240129004750225](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240129004750225.png)

# SpringCache

## 没有使用时的缓存菜品

### AOP操作

```java
@Pointcut("execution(* com.sky.controller.admin.*.*(..)) && @annotation(com.sky.annotation.CleanCache)")
public void CleanCachePointCut(){}

@Before("CleanCachePointCut()")
public void cleanCache(JoinPoint joinPoint){
    log.info("开始自动清理缓存数据");
    // 通过链接点对象获取到指定的方法签名
    MethodSignature signature = (MethodSignature) joinPoint.getSignature();
    // 拿到方法对应注解
    CleanCache cleanCache = signature.getMethod().getAnnotation(CleanCache.class);
    // 获取到这个注解使用的操作类型
    CleanCacheType value = cleanCache.value();
    // 拿到方法的名字
    String methodName = signature.getMethod().getName();
    // 获取到这个方法的所属类的名称
    Class<?> declaringClass = signature.getMethod().getDeclaringClass();
    String className = declaringClass.getName();
    log.info("当前执行方法的属类是：{}",className);
    if (className.contains("DishController")){
        if (value == CleanCacheType.INSERT){
            // 新增操作，只需要删除菜品所在的单一分类缓存
            // 获取方法参数
            Object[] args = joinPoint.getArgs();
            DishDTO dishDTO = (DishDTO) args[0];
            log.info("开始删除缓存");
            Long categoryId = dishDTO.getCategoryId();
            String key = "dish_" + categoryId;
            log.info("新增菜品分类id:{}",key);
            redisTemplate.delete(key);
        }
        if (value == CleanCacheType.UPDATE){
            // 更新操作删除所有缓存数据
            if (methodName.equals("ChangeStatus")){
                log.info("该操作正在修改方法的售卖状态");
                // 拿到方法参数，获取菜品id,然后拿到分类id，清除缓存
                Object[] args = joinPoint.getArgs();
                Long id = (Long) args[1];
                DishVO dishVO = dishMapper.selectByDishId(id);
                Long categoryId = dishVO.getCategoryId();
                String key = "dish_" + categoryId;
                redisTemplate.delete(key);
            }else {
                log.info("正在更新菜品数据");
                log.info("开始删除所有菜品缓存");
                Set keys = redisTemplate.keys(DISH_PATTERN);
                redisTemplate.delete(keys);
            }
        }
        if (value == CleanCacheType.DELETE){
            // 删除操作也只需要清除单一分类下的缓存
            // 获取方法参数
            Object[] args = joinPoint.getArgs();
            List<Long> ids = (List<Long>) args[0];
            // 开始删除缓存
            List<Long> categoryList = new ArrayList<>(ids.size());
            for (Long id : ids) {
                DishVO dishVO = dishMapper.selectByDishId(id);
                Long categoryId = dishVO.getCategoryId();
                categoryList.add(categoryId);
            }
            for (Long id : categoryList) {
                String key = "dish_" + id;
                redisTemplate.delete(key);
            }
        }
    }
}
```

## 定义

![image-20240204231635562](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240204231635562.png)

## 常用注解

![image-20240204232425233](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240204232425233.png)

# Spring Task

## 简介

![image-20240217011928359](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240217011928359.png)

## corn表达式

### 定义

corn是一个字符串，通过corn可以定义任务触发的时间

![image-20240217012841488](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240217012841488.png)

## 入门案例

```java
package com.sky.task;

import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.util.Date;

@Slf4j
@Component
public class myTask {

    @Scheduled(cron = "0/5 * * * * ?")
    public void testMyTask(){
        log.info("正在定时：{}",new Date());
    }

}
```

![image-20240217013508891](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240217013508891.png)

# WebSocket

## 简介

**![image-20240218005600352](%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96.assets/image-20240218005600352.png)**

